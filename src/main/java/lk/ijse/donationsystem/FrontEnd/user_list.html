<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            &#45;&#45;primary-color: #d32f2f;
            &#45;&#45;secondary-color: #1e88e5;
            &#45;&#45;dark-color: #263238;
            &#45;&#45;light-color: #f5f5f5;
            &#45;&#45;success-color: #43a047;
            &#45;&#45;warning-color: #ffa000;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: var(&#45;&#45;dark-color);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table thead {
            background-color: var(&#45;&#45;dark-color);
            color: white;
        }

        .table th {
            padding: 15px;
            font-weight: 500;
        }

        .table td {
            vertical-align: middle;
            padding: 12px 15px;
        }

        .badge-role {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-admin {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(&#45;&#45;primary-color);
        }

        .badge-donor {
            background-color: rgba(30, 136, 229, 0.1);
            color: var(&#45;&#45;secondary-color);
        }

        .badge-recipient {
            background-color: rgba(67, 160, 71, 0.1);
            color: var(&#45;&#45;success-color);
        }

        .status-active {
            color: var(&#45;&#45;success-color);
            font-weight: 500;
        }

        .status-inactive {
            color: var(&#45;&#45;primary-color);
            font-weight: 500;
        }

        .btn-action {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .btn-delete {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(&#45;&#45;primary-color);
        }

        .btn-enable {
            background-color: rgba(67, 160, 71, 0.1);
            color: var(&#45;&#45;success-color);
        }

        .btn-disable {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(&#45;&#45;warning-color);
        }

        .btn-edit:hover {
            background-color: #ffc107;
            color: white;
        }

        .btn-delete:hover {
            background-color: var(&#45;&#45;primary-color);
            color: white;
        }

        .btn-enable:hover {
            background-color: var(&#45;&#45;success-color);
            color: white;
        }

        .btn-disable:hover {
            background-color: var(&#45;&#45;warning-color);
            color: white;
        }

        .search-box {
            position: relative;
            max-width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-box input {
            padding-left: 35px;
            border-radius: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 0.25em solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #d32f2f;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        @media (max-width: 768px) {
            .table-responsive {
                margin: 0 -15px;
                width: calc(100% + 30px);
            }

            .search-box {
                max-width: 100%;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
&lt;!&ndash; Navigation &ndash;&gt;
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand text-white" href="#">
            <i class="fas fa-heartbeat me-2"></i> LifeSaver
        </a>
        <button class="btn text-white" onclick="window.location.href='admin-dashboard.html'">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </button>
    </div>
</nav>

&lt;!&ndash; Main Content &ndash;&gt;
<div class="container py-4">
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <h4 class="mb-0"><i class="fas fa-users me-2"></i> User Management</h4>
                <div class="d-flex">
                    <div class="search-box me-2">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
                    </div>
                    <button class="btn btn-danger" onclick="refreshUserList()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="userTableBody">
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted" id="userCount">Loading users...</div>
                <nav>
                    <ul class="pagination mb-0" id="pagination">
                        &lt;!&ndash; Pagination will be added dynamically &ndash;&gt;
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

&lt;!&ndash; Edit User Modal &ndash;&gt;
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editUserModalBody">
                &lt;!&ndash; Content will be loaded dynamically &ndash;&gt;
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveUserChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        checkAuthAndLoadUsers();

        $('#searchInput').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('#userTableBody tr').filter(function() {
                if ($(this).find('.loading-container').length) return false;
                $(this).toggle($(this).text().toLowerCase().indexOf(searchTerm) > -1);
            });
        });
    });

    function checkAuthAndLoadUsers() {
        const authToken = localStorage.getItem('authToken');

        if (!authToken) {
            showErrorAndRedirect('Session expired', 'Please login again');
            return;
        }

        loadUserList();
    }

    function loadUserList() {
        showLoadingState();

        $.ajax({
            url: 'http://localhost:8080/api/v1/user/getAll',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            },
            success: function(response) {
                if (!response || !response.data || response.data.length === 0) {
                    showNoUsersFound();
                    return;
                }
                populateUserTable(response.data);
            },
            error: function(xhr) {
                handleApiError(xhr);
            }
        });
    }

    function showLoadingState() {
        $('#userTableBody').html(`
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                        </div>
                    </td>
                </tr>
            `);
        $('#userCount').text('Loading users...');
    }

    function showNoUsersFound() {
        $('#userTableBody').html(`
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-users-slash me-2"></i> No users found
                    </td>
                </tr>
            `);
        $('#userCount').text('0 users found');
    }

    function populateUserTable(users) {
        let tableContent = '';

        users.forEach(user => {
            const statusClass = user.status === 'ENABLED' ? 'status-active' : 'status-inactive';
            const statusButton = user.status === 'ENABLED' ?
                `<button class="btn-action btn-disable ms-2" onclick="updateUserStatus('${user.email}', 'DISABLED')">
                        <i class="fas fa-ban me-1"></i>Disable
                    </button>` :
                `<button class="btn-action btn-enable ms-2" onclick="updateUserStatus('${user.email}', 'ENABLED')">
                        <i class="fas fa-check me-1"></i>Enable
                    </button>`;

            let roleBadgeClass = '';
            if (user.role === 'ADMIN') roleBadgeClass = 'badge-admin';
            else if (user.role === 'DONOR') roleBadgeClass = 'badge-donor';
            else if (user.role === 'RECIPIENT') roleBadgeClass = 'badge-recipient';

            tableContent += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=random"
                                     alt="User" class="user-avatar">
                                <span>${user.name || 'No name'}</span>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td><span class="badge-role ${roleBadgeClass}">${user.role}</span></td>
                        <td class="${statusClass}">${user.status}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="openEditModal('${user.email}')">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button class="btn-action btn-delete ms-2" onclick="deleteUser('${user.email}')">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                            ${statusButton}
                        </td>
                    </tr>
                `;
        });

        $('#userTableBody').html(tableContent);
        $('#userCount').text(`Total Users: ${users.length}`);
    }

    function updateUserStatus(email, status) {
        event.stopPropagation();

        const authToken = localStorage.getItem('authToken');
        const action = status === 'ENABLED' ? 'enable' : 'disable';

        Swal.fire({
            title: `Are you sure you want to ${action} this user?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: `Yes, ${action}`
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `http://localhost:8080/api/v1/user/status?email=${email}&status=${status}`,
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    },
                    success: function() {
                        Swal.fire({
                            title: 'Success',
                            text: `User ${action}d successfully`,
                            icon: 'success'
                        });
                        loadUserList();
                    },
                    error: function() {
                        Swal.fire({
                            title: 'Error',
                            text: `Failed to ${action} user`,
                            icon: 'error'
                        });
                    }
                });
            }
        });
    }

    function deleteUser(email) {
        event.stopPropagation();

        const authToken = localStorage.getItem('authToken');

        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `http://localhost:8080/api/v1/user/delete/${email}`,
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    },
                    success: function() {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'User has been deleted.',
                            icon: 'success'
                        });
                        loadUserList();
                    },
                    error: function() {
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to delete user',
                            icon: 'error'
                        });
                    }
                });
            }
        });
    }

    function openEditModal(email) {
        event.stopPropagation();

        const authToken = localStorage.getItem('authToken');

        $.ajax({
            url: `http://localhost:8080/api/v1/user/get/${email}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + authToken
            },
            success: function(user) {
                $('#editUserModalBody').html(`
                        <form id="editUserForm">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" value="${user.name}" id="editUserName">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="${user.email}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Role</label>
                                <select class="form-select" id="editUserRole">
                                    <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>Admin</option>
                                    <option value="DONOR" ${user.role === 'DONOR' ? 'selected' : ''}>Donor</option>
                                    <option value="RECIPIENT" ${user.role === 'RECIPIENT' ? 'selected' : ''}>Recipient</option>
                                </select>
                            </div>
                        </form>
                    `);

                const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                editModal.show();

                $('#saveUserChanges').off().on('click', function() {
                    saveUserChanges(email);
                });
            },
            error: function() {
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to load user data',
                    icon: 'error'
                });
            }
        });
    }

    function saveUserChanges(email) {
        const authToken = localStorage.getItem('authToken');
        const name = $('#editUserName').val();
        const role = $('#editUserRole').val();

        $.ajax({
            url: `http://localhost:8080/api/v1/user/update/${email}`,
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                name: name,
                role: role
            }),
            success: function() {
                Swal.fire({
                    title: 'Success',
                    text: 'User updated successfully',
                    icon: 'success'
                });
                $('#editUserModal').modal('hide');
                loadUserList();
            },
            error: function() {
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to update user',
                    icon: 'error'
                });
            }
        });
    }

    function handleApiError(xhr) {
        console.error("API Error:", xhr);

        let errorMessage = "Failed to load user list";
        if (xhr.status === 401) {
            errorMessage = "Session expired - please login again";
            localStorage.removeItem('authToken');
            setTimeout(() => window.location.href = '../auth/login.html', 2000);
        } else if (xhr.status === 403) {
            errorMessage = "You don't have permission to view users";
        }

        $('#userTableBody').html(`
                <tr>
                    <td colspan="5" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${errorMessage}
                    </td>
                </tr>
            `);

        Swal.fire({
            title: 'Error',
            text: errorMessage,
            icon: 'error'
        });
    }

    function showErrorAndRedirect(title, message) {
        Swal.fire({
            title: title,
            text: message,
            icon: 'warning'
        }).then(() => {
            window.location.href = '../auth/login.html';
        });
    }

    function refreshUserList() {
        loadUserList();
    }
</script>
</body>
</html>

-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User List</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #f4f7fb;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .navbar {
            background-color: #1E2A47;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h2 {
            margin: 0;
        }

        .navbar button {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #1E2A47;
            color: white;
        }

        .edit-btn, .delete-btn, .enable-btn, .disable-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .edit-btn {
            background-color: #4CAF50;
            color: white;
        }

        .edit-btn:hover {
            background-color: #388E3C;
        }

        .delete-btn {
            background-color: #FF6347;
            color: white;
        }

        .delete-btn:hover {
            background-color: #FF4500;
        }

        .enable-btn {
            background-color: #4CAF50;
            color: white;
        }

        .enable-btn:hover {
            background-color: #388E3C;
        }

        .disable-btn {
            background-color: #FF6347;
            color: white;
        }

        .disable-btn:hover {
            background-color: #FF4500;
        }
    </style>
</head>
<body>

&lt;!&ndash; Navbar &ndash;&gt;
<div class="navbar">
    <h2>Admin Dashboard</h2>
    <button onclick="window.location.href='Admin.html'">
        <i class="fas fa-arrow-left"></i> Back
    </button>
</div>

<div class="container">
    <h2>User List</h2>
    <table id="userTable">
        <thead>
        <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="userTableBody">
        &lt;!&ndash; User rows will be populated dynamically &ndash;&gt;
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function() {
        getAllUsers();
    });

    function getAllUsers() {
        const authToken = localStorage.getItem('authToken');
        let tableBody = $('#userTableBody');

        tableBody.html('<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');

        $.ajax({
            url: "http://localhost:8080/api/v1/user/getAll",
            method: "GET",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function(response) {
                tableBody.empty();
                const users = response.data || [];

                if (users.length === 0) {
                    tableBody.html('<tr><td colspan="5" class="text-center">No users found</td></tr>');
                    return;
                }

                users.forEach(user => {
                    tableBody.append(`
                    <tr>
                        <td>${user.email}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>${user.status}</td>
                        <td>
                            <button class="edit-btn" onclick="editUser('${user.email}')">✏️ Edit</button>
                            <button class="delete-btn" onclick="deleteUser('${user.email}')">🗑️ Delete</button>
                            ${user.status === "ENABLED" ?
                        `<button class="disable-btn" onclick="updateUserStatus('${user.email}', 'DISABLED')">Disable</button>` :
                        `<button class="enable-btn" onclick="updateUserStatus('${user.email}', 'ENABLED')">Enable</button>`
                    }
                        </td>
                    </tr>
                `);
                });
            },
            error: function(xhr) {
                Swal.fire("Error!", "Failed to load users!", "error");
            }
        });
    }

    function deleteUser(email) {
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this action!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                const authToken = localStorage.getItem('authToken');

                $.ajax({
                    url: `http://localhost:8080/api/v1/user/delete/${email}`,
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${authToken}` },
                    success: function() {
                        Swal.fire("Deleted!", "User has been removed.", "success");
                        getAllUsers();
                    },
                    error: function() {
                        Swal.fire("Error!", "Failed to delete user!", "error");
                    }
                });
            }
        });
    }

    function editUser(email) {
        Swal.fire({
            title: "Edit User",
            text: `Editing user ID: ${email}`,
            icon: "info"
        });
    }

    function updateUserStatus(email, status) {
        const authToken = localStorage.getItem('authToken');

        $.ajax({
            url: `http://localhost:8080/api/v1/user/status?email=${email}&status=${status}`,
            method: "PUT",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function(response) {
                Swal.fire("Success", "User status updated", "success");
                getAllUsers();
            },
            error: function(xhr) {
                Swal.fire("Error!", "Failed to update status", "error");
            }
        });
    }
</script>

</body>
</html>

